<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Controle de Frota - Irrigação</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0;
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
        }
        
        .logo {
            flex: 1;
        }
        
        .logo h1 {
            color: #2c3e50;
            margin-bottom: 5px;
        }
        
        .logo p {
            color: #7f8c8d;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .user {
            background-color: #ecf0f1;
            padding: 10px 15px;
            border-radius: 5px;
            font-weight: bold;
        }
        
        .filters {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
            padding: 15px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            min-width: 180px;
        }
        
        .filter-group label {
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        .filter-group input, .filter-group select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.2s;
        }
        
        .btn-primary {
            background-color: #3498db;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #2980b9;
        }
        
        .btn-success {
            background-color: #2ecc71;
            color: white;
        }
        
        .btn-success:hover {
            background-color: #27ae60;
        }
        
        .btn-danger {
            background-color: #e74c3c;
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #c0392b;
        }
        
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .summary-card {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            text-align: center;
        }
        
        .summary-card h3 {
            margin-bottom: 10px;
            color: #7f8c8d;
            font-size: 14px;
            font-weight: 600;
        }
        
        .summary-card .value {
            font-size: 24px;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .charts-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .chart-card {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .chart-card h3 {
            margin-bottom: 15px;
            color: #2c3e50;
        }
        
        .chart-container {
            position: relative;
            height: 300px;
        }
        
        .actions {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .card {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-bottom: 30px;
        }
        
        .card-header {
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .card-header h2 {
            color: #2c3e50;
        }
        
        .card-body {
            padding: 20px;
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: #2c3e50;
        }
        
        tr:hover {
            background-color: #f8f9fa;
        }
        
        .status {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .status-pro {
            background-color: #e6f7ee;
            color: #0fa14c;
        }
        
        .status-na-ofc {
            background-color: #fbdfdb;
            color: #e74c3c;
        }
        
        .status-ag {
            background-color: #fef5ec;
            color: #f39c12;
        }
        
        .form-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .modal-content {
            background-color: white;
            border-radius: 8px;
            width: 600px;
            max-width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h2 {
            color: #2c3e50;
        }
        
        .modal-body {
            padding: 20px;
        }
        
        .modal-footer {
            padding: 15px 20px;
            border-top: 1px solid #eee;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        .form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .form-group {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .form-group label {
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        .form-group input, .form-group select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .horas-operacoes {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }
        
        .horas-operacoes h3 {
            margin-bottom: 15px;
            color: #2c3e50;
        }
        
        .operacao-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }
        
        .operacao-item:last-child {
            border-bottom: none;
        }
        
        .operacao-nome {
            font-weight: 500;
        }
        
        .operacao-horas {
            color: #7f8c8d;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 5px;
            background-color: #2ecc71;
            color: white;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            opacity: 0;
            transform: translateY(-20px);
            transition: opacity 0.3s, transform 0.3s;
            z-index: 2000;
        }

        .notification.show {
            opacity: 1;
            transform: translateY(0);
        }
        
        @media (max-width: 768px) {
            .charts-container {
                grid-template-columns: 1fr;
            }
            
            .filters {
                flex-direction: column;
            }
            
            .actions {
                flex-direction: column;
                align-items: stretch;
            }
            
            .btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">
                <h1>Controle de Frota - Irrigação</h1>
                <p>Monitoramento de veículos e máquinas</p>
            </div>
            <div class="user-info">
                <div class="user">
                    <span>Usuário: Admin</span>
                </div>
                <button class="btn btn-danger" onclick="limparDados()">Limpar Tudo</button>
            </div>
        </header>
        
        <div class="filters">
            <div class="filter-group">
                <label for="dataInicio">Data Início</label>
                <input type="date" id="dataInicio">
            </div>
            <div class="filter-group">
                <label for="dataFim">Data Fim</label>
                <input type="date" id="dataFim">
            </div>
            <div class="filter-group">
                <label for="frota">Frota</label>
                <select id="frota">
                    <option value="">Todas</option>
                    <option value="601017">601017 - CAMINHÃO</option>
                    <option value="602048">602048 - TRATOR</option>
                    <option value="602049">602049 - TRATOR</option>
                    <option value="602001">602001 - TANQUE AP</option>
                    <option value="602002">602002 - TANQUE AP</option>
                    <option value="601007">601007 - CAMINHÃO</option>
                    <option value="601008">601008 - CAMINHÃO</option>
                    <option value="601018">601018 - CAMINHÃO</option>
                    <option value="601044">601044 - CAMINHÃO</option>
                    <option value="606001">606001 - TANQUE TP</option>
                    <option value="606002">606002 - TANQUE TP</option>
                    <option value="606003">606003 - TANQUE TP</option>
                    <option value="606004">606004 - TANQUE TP</option>
                    <option value="606005">606005 - TANQUE TP</option>
                    <option value="606006">606006 - TANQUE TP</option>
                    <option value="606007">606007 - TANQUE TP</option>
                    <option value="606008">606008 - TANQUE TP</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="operacao">Operação</label>
                <select id="operacao">
                    <option value="">Todas</option>
                    <option value="PRO">PRO - Produção</option>
                    <option value="NA OFC">NA OFC - Na Oficina</option>
                    <option value="AG. OF. MEC">AG. OF. MEC - Ag. Oficina Mecânica</option>
                    <option value="AGUAR. CONSERT">AGUAR. CONSERT - Aguardando Conserto</option>
                    <option value="AG. SERRALHEIRO">AG. SERRALHEIRO - Ag. Serralheiro</option>
                    <option value="FALTA OPER">FALTA OPER - Falta Operador</option>
                    <option value="RESERVA">RESERVA - Reserva</option>
                    <option value="OFC PIT STOP">OFC PIT STOP - Oficina Pit Stop</option>
                    <option value="AG. BORRACHEIRO">AG. BORRACHEIRO - Ag. Borracheiro</option>
                    <option value="REVISAO">REVISAO - Revisão</option>
                    <option value="CHUVA">CHUVA - Chuva</option>
                    <option value="FALTA COMBUSTIVEL">FALTA COMBUSTIVEL - Falta de Combustível</option>
                </select>
            </div>
            <div class="filter-group">
                <label style="visibility: hidden;">Filtrar</label>
                <button class="btn btn-primary" onclick="filtrarRegistros()">Filtrar</button>
            </div>
        </div>
        
        <div class="summary-cards">
            <div class="summary-card">
                <h3>Total de Veículos</h3>
                <div class="value" id="total-veiculos">0</div>
            </div>
            <div class="summary-card">
                <h3>Em Operação</h3>
                <div class="value" id="em-operacao">0</div>
            </div>
            <div class="summary-card">
                <h3>Em Manutenção</h3>
                <div class="value" id="em-manutencao">0</div>
            </div>
            <div class="summary-card">
                <h3>Horas Produtivas</h3>
                <div class="value" id="horas-produtivas">0</div>
            </div>
        </div>
        
        <div class="horas-operacoes">
            <h3>Horas por Tipo de Operação</h3>
            <div id="operacoes-lista">
                <!-- As operações e horas serão carregadas aqui via JavaScript -->
            </div>
        </div>
        
        <div class="charts-container">
            <div class="chart-card">
                <h3>Distribuição de Horas por Tipo de Operação</h3>
                <div class="chart-container">
                    <canvas id="operacaoChart"></canvas>
                </div>
            </div>
            <div class="chart-card">
                <h3>Impacto de Horas Paradas na Produtividade</h3>
                <div class="chart-container">
                    <canvas id="impactoChart"></canvas>
                </div>
            </div>
        </div>
        
        <div class="actions">
            <button class="btn btn-primary" onclick="abrirModal()">Novo Registro</button>
            <button class="btn btn-success" onclick="salvarDados()">Salvar Backup</button>
            <button class="btn btn-success" onclick="importarDados()">Restaurar Backup</button>
            <button class="btn btn-primary" onclick="exportarDados()">Exportar Dados</button>
        </div>
        
        <div class="card">
            <div class="card-header">
                <h2>Registros de Disponibilidade</h2>
                <span id="total-registros">0 registros encontrados</span>
            </div>
            <div class="card-body">
                <table id="tabela-registros">
                    <thead>
                        <tr>
                            <th>Chave</th>
                            <th>Data</th>
                            <th>Frota</th>
                            <th>Classe</th>
                            <th>Operação</th>
                            <th>Tipo Oper</th>
                            <th>Hora Início</th>
                            <th>Hora Fim</th>
                            <th>Hora Total</th>
                            <th>N° da O.S.</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Os registros serão carregados aqui via JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- Modal para adicionar/editar registros -->
    <div class="form-modal" id="modalRegistro">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitulo">Novo Registro</h2>
                <span style="cursor: pointer;" onclick="fecharModal()">×</span>
            </div>
            <div class="modal-body">
                <form id="formRegistro">
                    <input type="hidden" id="registroId">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="modalData">Data</label>
                            <input type="date" id="modalData" required>
                        </div>
                        <div class="form-group">
                            <label for="modalFrota">Frota</label>
                            <select id="modalFrota" required onchange="atualizarClasse()">
                                <option value="">Selecione...</option>
                                <option value="601017">601017 - CAMINHÃO</option>
                                <option value="602048">602048 - TRATOR</option>
                                <option value="602049">602049 - TRATOR</option>
                                <option value="602001">602001 - TANQUE AP</option>
                                <option value="602002">602002 - TANQUE AP</option>
                                <option value="601007">601007 - CAMINHÃO</option>
                                <option value="601008">601008 - CAMINHÃO</option>
                                <option value="601018">601018 - CAMINHÃO</option>
                                <option value="601044">601044 - CAMINHÃO</option>
                                <option value="606001">606001 - TANQUE TP</option>
                                <option value="606002">606002 - TANQUE TP</option>
                                <option value="606003">606003 - TANQUE TP</option>
                                <option value="606004">606004 - TANQUE TP</option>
                                <option value="606005">606005 - TANQUE TP</option>
                                <option value="606006">606006 - TANQUE TP</option>
                                <option value="606007">606007 - TANQUE TP</option>
                                <option value="606008">606008 - TANQUE TP</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="modalClasse">Classe</label>
                            <select id="modalClasse" required>
                                <option value="">Selecione...</option>
                                <option value="CAMINHÃO">CAMINHÃO</option>
                                <option value="TRATOR">TRATOR</option>
                                <option value="TANQUE AP">TANQUE AP</option>
                                <option value="TANQUE TP">TANQUE TP</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="modalOperacao">Operação</label>
                            <select id="modalOperacao" required onchange="atualizarTipoOperacao()">
                                <option value="">Selecione...</option>
                                <option value="PRO">PRO - Produção</option>
                                <option value="NA OFC">NA OFC - Na Oficina</option>
                                <option value="AG. OF. MEC">AG. OF. MEC - Ag. Oficina Mecânica</option>
                                <option value="AGUAR. CONSERT">AGUAR. CONSERT - Aguardando Conserto</option>
                                <option value="AG. SERRALHEIRO">AG. SERRALHEIRO - Ag. Serralheiro</option>
                                <option value="FALTA OPER">FALTA OPER - Falta Operador</option>
                                <option value="RESERVA">RESERVA - Reserva</option>
                                <option value="OFC PIT STOP">OFC PIT STOP - Oficina Pit Stop</option>
                                <option value="AG. BORRACHEIRO">AG. BORRACHEIRO - Ag. Borracheiro</option>
                                <option value="REVISAO">REVISAO - Revisão</option>
                                <option value="CHUVA">CHUVA - Chuva</option>
                                <option value="FALTA COMBUSTIVEL">FALTA COMBUSTIVEL - Falta de Combustível</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="modalTipoOper">Tipo Operação</label>
                            <input type="text" id="modalTipoOper" readonly>
                        </div>
                        <div class="form-group">
                            <label for="modalOs">N° da O.S.</label>
                            <input type="text" id="modalOs">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="modalHoraInicio">Hora Início</label>
                            <input type="time" id="modalHoraInicio" required>
                        </div>
                        <div class="form-group">
                            <label for="modalHoraFim">Hora Fim</label>
                            <input type="time" id="modalHoraFim" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="modalHoraTotal">Hora Total (minutos)</label>
                            <input type="text" id="modalHoraTotal" readonly>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="fecharModal()">Cancelar</button>
                <button class="btn btn-primary" onclick="salvarRegistro()">Salvar</button>
            </div>
        </div>
    </div>

    <div class="notification" id="notification">Operação realizada com sucesso!</div>

    <script>
        // Chave para armazenamento local
        const STORAGE_KEY = 'controle_frota_irrigacao';
        
        // Dados iniciais
        let registros = [];
        
        // Mapeamento de frotas para classes
        const mapeamentoFrotas = {
            '601017': 'CAMINHÃO',
            '602048': 'TRATOR',
            '602049': 'TRATOR',
            '602001': 'TANQUE AP',
            '602002': 'TANQUE AP',
            '601007': 'CAMINHÃO',
            '601008': 'CAMINHÃO',
            '601018': 'CAMINHÃO',
            '601044': 'CAMINHÃO',
            '606001': 'TANQUE TP',
            '606002': 'TANQUE TP',
            '606003': 'TANQUE TP',
            '606004': 'TANQUE TP',
            '606005': 'TANQUE TP',
            '606006': 'TANQUE TP',
            '606007': 'TANQUE TP',
            '606008': 'TANQUE TP'
        };
        
        // Mapeamento de operações para tipos (simulando o VLOOKUP)
        const mapeamentoOperacoes = {
            'PRO': 'PRO',
            'NA OFC': 'IMP',
            'AG. OF. MEC': 'AG. OF. MEC',
            'AGUAR. CONSERT': 'AGUAR. CONSERT',
            'AG. SERRALHEIRO': 'AG. SERRALHEIRO',
            'FALTA OPER': 'FALTA OPER',
            'RESERVA': 'RESERVA',
            'OFC PIT STOP': 'OFC PIT STOP',
            'AG. BORRACHEIRO': 'AG. BORRACHEIRO',
            'REVISAO': 'REVISAO',
            'CHUVA': 'CHUVA',
            'FALTA COMBUSTIVEL': 'FALTA COMBUSTIVEL'
        };

        // Cores para cada tipo de operação
        const coresOperacoes = {
            'PRO': '#2ecc71', // Verde
            'NA OFC': '#e74c3c', // Vermelho
            'AG. OF. MEC': '#f39c12', // Laranja
            'AGUAR. CONSERT': '#9b59b6', // Roxo
            'AG. SERRALHEIRO': '#3498db', // Azul
            'FALTA OPER': '#f1c40f', // Amarelo
            'RESERVA': '#f1c40f', // Amarelo (mesma cor de falta oper)
            'OFC PIT STOP': '#16a085', // Verde-água
            'AG. BORRACHEIRO': '#d35400', // Laranja escuro
            'REVISAO': '#8e44ad', // Roxo escuro
            'CHUVA': '#3498db', // Azul (alterado para azul)
            'FALTA COMBUSTIVEL': '#c0392b' // Vermelho escuro
        };

        // Variáveis para os gráficos
        let operacaoChart = null;
        let impactoChart = null;

        // Função para carregar dados do localStorage
        function carregarDados() {
            const dados = localStorage.getItem(STORAGE_KEY);
            if (dados) {
                return JSON.parse(dados);
            } else {
                // Dados iniciais se não houver nada salvo
                return [];
            }
        }

        // Função para salvar dados no localStorage
        function salvarDadosLocal() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(registros));
            mostrarNotificacao('Dados salvos com sucesso!');
        }

        // Função para mostrar notificação
        function mostrarNotificacao(mensagem) {
            const notification = document.getElementById('notification');
            notification.textContent = mensagem;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // Carregar registros ao iniciar
        document.addEventListener('DOMContentLoaded', function() {
            // Carregar dados do localStorage
            registros = carregarDados();
            
            carregarRegistros();
            atualizarResumo();
            criarGraficos();
            atualizarHorasOperacoes();
            
            // Adicionar event listeners para os campos de hora
            document.getElementById('modalHoraInicio').addEventListener('change', calcularHoraTotal);
            document.getElementById('modalHoraFim').addEventListener('change', calcularHoraTotal);
            
            // Preencher data atual
            const hoje = new Date().toISOString().split('T')[0];
            document.getElementById('modalData').value = hoje;
            document.getElementById('dataInicio').value = hoje;
            document.getElementById('dataFim').value = hoje;
        });

        // Função para carregar registros na tabela
        function carregarRegistros(filtros = {}) {
            const tbody = document.querySelector('#tabela-registros tbody');
            tbody.innerHTML = '';
            
            let registrosFiltrados = registros;
            
            // Aplicar filtros
            if (filtros.dataInicio && filtros.dataFim) {
                registrosFiltrados = registrosFiltrados.filter(r => r.data >= filtros.dataInicio && r.data <= filtros.dataFim);
            }
            
            if (filtros.frota) {
                registrosFiltrados = registrosFiltrados.filter(r => r.frota === filtros.frota);
            }
            
            if (filtros.operacao) {
                registrosFiltrados = registrosFiltrados.filter(r => r.operacao === filtros.operacao);
            }
            
            // Atualizar contador
            document.getElementById('total-registros').textContent = `${registrosFiltrados.length} registros encontrados`;
            
            // Preencher tabela
            registrosFiltrados.forEach(registro => {
                const tr = document.createElement('tr');
                
                // Calcular chave (como na planilha: CONCATENATE(E5,"_",D5))
                const chave = `${registro.frota}_${registro.data}`;
                
                // Formatar hora total (minutos para formato legível)
                const horas = Math.floor(registro.horaTotal / 60);
                const minutos = registro.horaTotal % 60;
                const horaTotalFormatada = `${horas.toString().padStart(2, '0')}:${minutos.toString().padStart(2, '0')}`;
                
                // Determinar classe CSS para status
                let statusClass = '';
                if (registro.operacao === 'PRO') statusClass = 'status-pro';
                else if (registro.operacao.includes('NA OFC')) statusClass = 'status-na-ofc';
                else statusClass = 'status-ag';
                
                tr.innerHTML = `
                    <td>${chave}</td>
                    <td>${formatarData(registro.data)}</td>
                    <td>${registro.frota}</td>
                    <td>${registro.classe}</td>
                    <td><span class="status ${statusClass}">${registro.operacao}</span></td>
                    <td>${registro.tipoOper}</td>
                    <td>${registro.horaInicio}</td>
                    <td>${registro.horaFim}</td>
                    <td>${horaTotalFormatada}</td>
                    <td>${registro.os || ''}</td>
                    <td>
                        <button class="btn" onclick="editarRegistro(${registro.id})">Editar</button>
                        <button class="btn btn-danger" onclick="excluirRegistro(${registro.id})">Excluir</button>
                    </td>
                `;
                
                tbody.appendChild(tr);
            });
        }
        
        // Função para aplicar filtros
        function filtrarRegistros() {
            const dataInicio = document.getElementById('dataInicio').value;
            const dataFim = document.getElementById('dataFim').value;
            const frota = document.getElementById('frota').value;
            const operacao = document.getElementById('operacao').value;
            
            carregarRegistros({ dataInicio, dataFim, frota, operacao });
            atualizarResumo({ dataInicio, dataFim, frota, operacao });
            atualizarGraficos({ dataInicio, dataFim, frota, operacao });
            atualizarHorasOperacoes({ dataInicio, dataFim, frota, operacao });
        }
        
        // Função para atualizar o resumo
        function atualizarResumo(filtros = {}) {
            let registrosFiltrados = registros;
            
            // Aplicar filtros
            if (filtros.dataInicio && filtros.dataFim) {
                registrosFiltrados = registrosFiltrados.filter(r => r.data >= filtros.dataInicio && r.data <= filtros.dataFim);
            }
            
            if (filtros.frota) {
                registrosFiltrados = registrosFiltrados.filter(r => r.frota === filtros.frota);
            }
            
            if (filtros.operacao) {
                registrosFiltrados = registrosFiltrados.filter(r => r.operacao === filtros.operacao);
            }
            
            // Calcular totais
            const totalVeiculos = new Set(registrosFiltrados.map(r => r.frota)).size;
            const emOperacao = registrosFiltrados.filter(r => r.operacao === 'PRO').length;
            const emManutencao = registrosFiltrados.filter(r => r.operacao !== 'PRO').length;
            
            // Calcular horas produtivas (apenas registros PRO)
            const horasProdutivas = registrosFiltrados
                .filter(r => r.operacao === 'PRO')
                .reduce((total, r) => total + r.horaTotal, 0) / 60; // Converter minutos para horas
            
            // Atualizar elementos
            document.getElementById('total-veiculos').textContent = totalVeiculos;
            document.getElementById('em-operacao').textContent = emOperacao;
            document.getElementById('em-manutencao').textContent = emManutencao;
            document.getElementById('horas-produtivas').textContent = Math.round(horasProdutivas);
        }
        
        // Função para atualizar a lista de horas por operação
        function atualizarHorasOperacoes(filtros = {}) {
            let registrosFiltrados = registros;
            
            // Aplicar filtros
            if (filtros.dataInicio && filtros.dataFim) {
                registrosFiltrados = registrosFiltrados.filter(r => r.data >= filtros.dataInicio && r.data <= filtros.dataFim);
            }
            
            if (filtros.frota) {
                registrosFiltrados = registrosFiltrados.filter(r => r.frota === filtros.frota);
            }
            
            if (filtros.operacao) {
                registrosFiltrados = registrosFiltrados.filter(r => r.operacao === filtros.operacao);
            }
            
            // Calcular totais por tipo de operação
            const totaisPorOperacao = {};
            registrosFiltrados.forEach(registro => {
                if (!totaisPorOperacao[registro.operacao]) {
                    totaisPorOperacao[registro.operacao] = 0;
                }
                totaisPorOperacao[registro.operacao] += registro.horaTotal;
            });
            
            // Converter minutos para horas
            const totaisEmHoras = {};
            Object.keys(totaisPorOperacao).forEach(op => {
                totaisEmHoras[op] = (totaisPorOperacao[op] / 60).toFixed(1);
            });
            
            // Ordenar por horas (maior para menor)
            const operacoesOrdenadas = Object.keys(totaisEmHoras).sort((a, b) => totaisEmHoras[b] - totaisEmHoras[a]);
            
            // Atualizar a lista na interface
            const operacoesLista = document.getElementById('operacoes-lista');
            operacoesLista.innerHTML = '';
            
            operacoesOrdenadas.forEach(op => {
                const div = document.createElement('div');
                div.className = 'operacao-item';
                div.innerHTML = `
                    <span class="operacao-nome">${op}</span>
                    <span class="operacao-horas">${totaisEmHoras[op]} horas</span>
                `;
                operacoesLista.appendChild(div);
            });
        }
        
        // Função para criar/atualizar os gráficos
        function criarGraficos(filtros = {}) {
            atualizarGraficos(filtros);
        }
        
        // Função para atualizar os gráficos
        function atualizarGraficos(filtros = {}) {
            let registrosFiltrados = registros;
            
            // Aplicar filtros
            if (filtros.dataInicio && filtros.dataFim) {
                registrosFiltrados = registrosFiltrados.filter(r => r.data >= filtros.dataInicio && r.data <= filtros.dataFim);
            }
            
            if (filtros.frota) {
                registrosFiltrados = registrosFiltrados.filter(r => r.frota === filtros.frota);
            }
            
            if (filtros.operacao) {
                registrosFiltrados = registrosFiltrados.filter(r => r.operacao === filtros.operacao);
            }
            
            // Calcular totais por tipo de operação
            const totaisPorOperacao = {};
            registrosFiltrados.forEach(registro => {
                if (!totaisPorOperacao[registro.operacao]) {
                    totaisPorOperacao[registro.operacao] = 0;
                }
                totaisPorOperacao[registro.operacao] += registro.horaTotal;
            });
            
            // Calcular totais para o gráfico de impacto
            const totalHoras = Object.values(totaisPorOperacao).reduce((acc, val) => acc + val, 0);
            const horasProdutivas = totaisPorOperacao['PRO'] || 0;
            
            // Calcular horas de reserva (RESERVA + AGUAR. CONSERT)
            const horasReserva = (totaisPorOperacao['RESERVA'] || 0) + (totaisPorOperacao['AGUAR. CONSERT'] || 0);
            
            // Calcular horas perdidas por chuva
            const horasChuva = totaisPorOperacao['CHUVA'] || 0;
            
            // Calcular outras horas improdutivas (excluindo PRO, RESERVA e AGUAR. CONSERT)
            const outrasOperacoes = Object.keys(totaisPorOperacao).filter(op => op !== 'PRO' && op !== 'RESERVA' && op !== 'AGUAR. CONSERT');
            const outrasHorasImprodutivas = outrasOperacoes.reduce((acc, op) => acc + (totaisPorOperacao[op] || 0), 0);
            
            // Preparar dados para o gráfico de operações (barras com porcentagens)
            const operacoesLabels = Object.keys(totaisPorOperacao);
            const operacoesDataValues = Object.values(totaisPorOperacao).map(val => val / 60); // Converter para horas
            
            // Gerar cores para cada operação
            const operacoesCores = operacoesLabels.map(op => coresOperacoes[op] || '#95a5a6');
            
            const operacoesData = {
                labels: operacoesLabels,
                datasets: [{
                    label: 'Horas por Operação',
                    data: operacoesDataValues,
                    backgroundColor: operacoesCores,
                    borderWidth: 0
                }]
            };
            
            // Preparar dados para o gráfico de impacto (pizza com horas)
            const impactoData = {
                labels: ['Produtiva', 'Reserva', 'Horas Perdidas por Chuva', 'Outras Paradas'],
                datasets: [{
                    data: [
                        horasProdutivas / 60, // Converter para horas
                        horasReserva / 60,    // Converter para horas
                        horasChuva / 60,      // Converter para horas
                        outrasHorasImprodutivas / 60 // Converter para horas
                    ],
                    backgroundColor: [
                        '#2ecc71', // Verde para produtiva
                        '#f1c40f', // Amarelo para reserva
                        '#3498db', // Azul para horas perdidas por chuva
                        '#e74c3c'  // Vermelho para outras paradas
                    ],
                    borderWidth: 0
                }]
            };
            
            // Destruir gráficos existentes se já existirem
            if (operacaoChart) {
                operacaoChart.destroy();
            }
            
            if (impactoChart) {
                impactoChart.destroy();
            }
            
            // Criar gráfico de operações
            const operacaoCtx = document.getElementById('operacaoChart').getContext('2d');
            operacaoChart = new Chart(operacaoCtx, {
                type: 'bar',
                data: operacoesData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Horas'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const op = operacoesData.labels[context.dataIndex];
                                    const porcentagem = ((context.raw / totalHoras) * 100).toFixed(1);
                                    return `${op}: ${context.raw.toFixed(1)} horas (${porcentagem}%)`;
                                }
                            }
                        }
                    }
                }
            });
            
            // Criar gráfico de impacto (pizza)
            const impactoCtx = document.getElementById('impactoChart').getContext('2d');
            impactoChart = new Chart(impactoCtx, {
                type: 'pie',
                data: impactoData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.label}: ${context.raw.toFixed(1)} horas`;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // Função para abrir modal de novo registro
        function abrirModal(registroId = null) {
            const modal = document.getElementById('modalRegistro');
            const titulo = document.getElementById('modalTitulo');
            
            if (registroId) {
                // Modo edição
                titulo.textContent = 'Editar Registro';
                preencherModal(registroId);
            } else {
                // Modo novo registro
                titulo.textContent = 'Novo Registro';
                document.getElementById('formRegistro').reset();
                document.getElementById('registroId').value = '';
                
                // Preencher data atual
                document.getElementById('modalData').value = new Date().toISOString().split('T')[0];
            }
            
            modal.style.display = 'flex';
        }
        
        // Função para fechar modal
        function fecharModal() {
            document.getElementById('modalRegistro').style.display = 'none';
        }
        
        // Função para preencher modal no modo edição
        function preencherModal(id) {
            const registro = registros.find(r => r.id === id);
            
            if (registro) {
                document.getElementById('registroId').value = registro.id;
                document.getElementById('modalData').value = registro.data;
                document.getElementById('modalFrota').value = registro.frota;
                document.getElementById('modalClasse').value = registro.classe;
                document.getElementById('modalOperacao').value = registro.operacao;
                document.getElementById('modalTipoOper').value = registro.tipoOper;
                document.getElementById('modalOs').value = registro.os || '';
                document.getElementById('modalHoraInicio').value = registro.horaInicio;
                document.getElementById('modalHoraFim').value = registro.horaFim;
                document.getElementById('modalHoraTotal').value = registro.horaTotal;
            }
        }
        
        // Função para atualizar a classe baseado na frota selecionada
        function atualizarClasse() {
            const frota = document.getElementById('modalFrota').value;
            const classe = mapeamentoFrotas[frota] || '';
            document.getElementById('modalClasse').value = classe;
        }
        
        // Função para atualizar tipo de operação baseado na operação selecionada
        function atualizarTipoOperacao() {
            const operacao = document.getElementById('modalOperacao').value;
            document.getElementById('modalTipoOper').value = mapeamentoOperacoes[operacao] || '';
        }
        
        // Função para calcular hora total
        function calcularHoraTotal() {
            const inicio = document.getElementById('modalHoraInicio').value;
            const fim = document.getElementById('modalHoraFim').value;
            
            if (inicio && fim) {
                const [inicioH, inicioM] = inicio.split(':').map(Number);
                const [fimH, fimM] = fim.split(':').map(Number);
                
                const totalMinutos = (fimH * 60 + fimM) - (inicioH * 60 + inicioM);
                
                // Garantir que não seja negativo (se passar da meia-noite)
                const horaTotal = totalMinutos >= 0 ? totalMinutos : totalMinutos + 1440;
                
                document.getElementById('modalHoraTotal').value = horaTotal;
            }
        }
        
        // Função para salvar registro (novo ou edição)
        function salvarRegistro() {
            const id = document.getElementById('registroId').value;
            const data = document.getElementById('modalData').value;
            const frota = document.getElementById('modalFrota').value;
            const classe = document.getElementById('modalClasse').value;
            const operacao = document.getElementById('modalOperacao').value;
            const tipoOper = document.getElementById('modalTipoOper').value;
            const os = document.getElementById('modalOs').value;
            const horaInicio = document.getElementById('modalHoraInicio').value;
            const horaFim = document.getElementById('modalHoraFim').value;
            const horaTotal = document.getElementById('modalHoraTotal').value;
            
            if (id) {
                // Editar registro existente
                const index = registros.findIndex(r => r.id === parseInt(id));
                if (index !== -1) {
                    registros[index] = {
                        id: parseInt(id),
                        data,
                        frota,
                        classe,
                        operacao,
                        tipoOper,
                        horaInicio,
                        horaFim,
                        horaTotal: parseInt(horaTotal),
                        os
                    };
                }
            } else {
                // Adicionar novo registro
                const novoId = registros.length > 0 ? Math.max(...registros.map(r => r.id)) + 1 : 1;
                registros.push({
                    id: novoId,
                    data,
                    frota,
                    classe,
                    operacao,
                    tipoOper,
                    horaInicio,
                    horaFim,
                    horaTotal: parseInt(horaTotal),
                    os
                });
                
                // Verificar se é uma operação PRO que termina às 23:59
                if (operacao === 'PRO' && horaFim === '23:59') {
                    // Apenas salvar e fechar o modal
                    salvarDadosLocal();
                    carregarRegistros();
                    atualizarResumo();
                    atualizarGraficos();
                    atualizarHorasOperacoes();
                    fecharModal();
                    return;
                }
                
                // Verificar se é uma operação que termina às 23:59 mas NÃO é PRO
                if (operacao !== 'PRO' && horaFim === '23:59') {
                    // Salvar dados primeiro
                    salvarDadosLocal();
                    carregarRegistros();
                    atualizarResumo();
                    atualizarGraficos();
                    atualizarHorasOperacoes();
                    
                    // Calcular próxima data (dia seguinte)
                    const nextDate = new Date(data);
                    nextDate.setDate(nextDate.getDate() + 1);
                    const nextDateStr = nextDate.toISOString().split('T')[0];
                    
                    // Preparar próximo registro automaticamente (próximo dia)
                    setTimeout(() => {
                        document.getElementById('modalData').value = nextDateStr;
                        document.getElementById('modalFrota').value = frota;
                        document.getElementById('modalClasse').value = classe;
                        document.getElementById('modalHoraInicio').value = '00:00';
                        document.getElementById('modalHoraFim').value = '23:59';
                        document.getElementById('modalOperacao').value = 'PRO';
                        document.getElementById('modalTipoOper').value = 'PRO';
                        document.getElementById('modalOs').value = '';
                        calcularHoraTotal();
                        
                        // Manter o modal aberto para o próximo registro
                        document.getElementById('modalTitulo').textContent = 'Novo Registro (Próximo Dia)';
                        document.getElementById('modalRegistro').style.display = 'flex';
                    }, 100);
                    return; // Não fechar o modal
                }
                
                // Verificar se é uma operação PRO que termina antes das 23:59
                if (operacao === 'PRO' && horaFim !== '23:59') {
                    // Salvar dados primeiro
                    salvarDadosLocal();
                    carregarRegistros();
                    atualizarResumo();
                    atualizarGraficos();
                    atualizarHorasOperacoes();
                    
                    // Preparar próximo registro automaticamente (parada)
                    setTimeout(() => {
                        document.getElementById('modalData').value = data;
                        document.getElementById('modalFrota').value = frota;
                        document.getElementById('modalClasse').value = classe;
                        document.getElementById('modalHoraInicio').value = horaFim;
                        document.getElementById('modalHoraFim').value = '';
                        document.getElementById('modalOperacao').value = '';
                        document.getElementById('modalTipoOper').value = '';
                        document.getElementById('modalOs').value = '';
                        document.getElementById('modalHoraTotal').value = '';
                        
                        // Manter o modal aberto para o próximo registro
                        document.getElementById('modalTitulo').textContent = 'Novo Registro (Parada)';
                        document.getElementById('modalRegistro').style.display = 'flex';
                    }, 100);
                    return; // Não fechar o modal
                }
                
                // Verificar se é uma parada que termina antes das 23:59
                if (operacao !== 'PRO' && horaFim !== '23:59') {
                    // Salvar dados primeiro
                    salvarDadosLocal();
                    carregarRegistros();
                    atualizarResumo();
                    atualizarGraficos();
                    atualizarHorasOperacoes();
                    
                    // Preparar próximo registro automaticamente (PRO)
                    setTimeout(() => {
                        document.getElementById('modalData').value = data;
                        document.getElementById('modalFrota').value = frota;
                        document.getElementById('modalClasse').value = classe;
                        document.getElementById('modalHoraInicio').value = horaFim;
                        document.getElementById('modalHoraFim').value = '23:59';
                        document.getElementById('modalOperacao').value = 'PRO';
                        document.getElementById('modalTipoOper').value = 'PRO';
                        document.getElementById('modalOs').value = '';
                        calcularHoraTotal();
                        
                        // Manter o modal aberto para o próximo registro
                        document.getElementById('modalTitulo').textContent = 'Novo Registro (Produção)';
                        document.getElementById('modalRegistro').style.display = 'flex';
                    }, 100);
                    return; // Não fechar o modal
                }
            }
            
            // Salvar dados localmente
            salvarDadosLocal();
            
            // Recarregar tabela e fechar modal
            carregarRegistros();
            atualizarResumo();
            atualizarGraficos();
            atualizarHorasOperacoes();
            fecharModal();
        }
        
        // Função para salvar dados em JSON
        function salvarDados() {
            const jsonData = JSON.stringify(registros, null, 2);
            const blob = new Blob([jsonData], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'registros_frota.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            mostrarNotificacao('Backup salvo com sucesso!');
        }

        // Função para importar dados de um arquivo JSON
        function importarDados() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = e => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = e => {
                        try {
                            const data = JSON.parse(e.target.result);
                            registros = data;
                            salvarDadosLocal();
                            carregarRegistros();
                            atualizarResumo();
                            atualizarGraficos();
                            atualizarHorasOperacoes();
                            mostrarNotificacao('Dados importados com sucesso!');
                        } catch (error) {
                            mostrarNotificacao('Erro ao importar arquivo: Formato inválido');
                        }
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        }

        // Função para editar registro
        function editarRegistro(id) {
            abrirModal(id);
        }
        
        // Função para excluir registro
        function excluirRegistro(id) {
            if (confirm('Tem certeza que deseja excluir este registro?')) {
                const index = registros.findIndex(r => r.id === id);
                if (index !== -1) {
                    registros.splice(index, 1);
                    salvarDadosLocal();
                    carregarRegistros();
                    atualizarResumo();
                    atualizarGraficos();
                    atualizarHorasOperacoes();
                    mostrarNotificacao('Registro excluído com sucesso!');
                }
            }
        }
        
        // Função para exportar dados (simulação)
        function exportarDados() {
            // Converter para CSV
            let csv = 'Chave,Data,Frota,Classe,Operação,Tipo Oper,Hora Início,Hora Fim,Hora Total,N° da O.S.\n';
            
            registros.forEach(registro => {
                const chave = `${registro.frota}_${registro.data}`;
                const horas = Math.floor(registro.horaTotal / 60);
                const minutos = registro.horaTotal % 60;
                const horaTotalFormatada = `${horas.toString().padStart(2, '0')}:${minutos.toString().padStart(2, '0')}`;
                
                csv += `"${chave}",${registro.data},${registro.frota},${registro.classe},${registro.operacao},${registro.tipoOper},${registro.horaInicio},${registro.horaFim},${horaTotalFormatada},${registro.os || ''}\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'registros_frota.csv';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            mostrarNotificacao('Dados exportados com sucesso!');
        }
        
        // Função para limpar todos os dados
        function limparDados() {
            if (confirm('Tem certeza que deseja limpar TODOS os dados? Esta ação não pode ser desfeita.')) {
                registros = [];
                salvarDadosLocal();
                carregarRegistros();
                atualizarResumo();
                atualizarGraficos();
                atualizarHorasOperacoes();
                mostrarNotificacao('Todos os dados foram removidos!');
            }
        }
        
        // Função auxiliar para formatar data
        function formatarData(dataStr) {
            const data = new Date(dataStr);
            return data.toLocaleDateString('pt-BR');
        }
    </script>
</body>
</html>